<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>A Simple XQuery Web Application</title>
  </head>

  <body>
    <h1>A Simple XQuery Web Application</h1>

<p>
In this article we will show to to write and install
a very simple "web application" written in the
<a href="http://www.w3.org/XML/Query">XQuery language</a>.
We will also show you how errors are handled, and how you can debug them.
Our application uses the servlet extension of
<a href="http://www.gnu.org/software/qexo/">Qexo</a>
(version 1.7beta2 or later), a Free implementation of XQuery.</p>
<p>
Our application presents to the user a form like the following:</p>
<img src="webapp-adder-1.png" title="Figure 1"
alt="First screenshot of adder webapp"
longdesc="webapp-adder-1.html"/>
<p>
You can edit either field, perhaps to 10 and 3.
When you click <code>Submit</code>,
you get an updated form showing the sum of the two fields:</p>
<img src="webapp-adder-2.png" title="Figure 2"
alt="Second screenshot of adder webapp, after Submit"/>
<p>
The application uses HTTP <dfn>parameters</dfn> to "remember" the sum from
one request to the next.  A more interesting application
might use some kind of permanent storage or a datebase.
We'll get those in later article, but for now let's think of
this as a slightly more interesting version of <code>"Hello world!"</code>.

<h2>An XQuery program to generate a form</h2>
<p>
The following simple XQuery program
<a href="adder.xql" type="text/plain"><code>adder.xql</code></a>
handles both the "logic" and "presentation" of our web application.

<pre>
define function num-parameter($name, $default) {
  number(request-parameter($name, $default))
}

&lt;html&gt;
  &lt;head&gt;&lt;title&gt;Accumulating Adder&lt;/title&gt;&lt;/head&gt;

  &lt;body&gt;
    &lt;form&gt;
      &lt;table&gt;
        &lt;tr&gt;
          &lt;td&gt;Result so far: &lt;/td&gt;
          &lt;td&gt;
            &lt;input
              name="sum1"
              value="{num-parameter("sum1", 0)
                     +num-parameter("sum2", 0)}" /&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;td&gt;Add to it:&lt;/td&gt;
          &lt;td&gt;
            &lt;input
              name="sum2"
              value="{num-parameter("sum2", 1)}" /&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
      &lt;/table&gt;
      &lt;input type="submit" value="Submit" /&gt;
    &lt;/form&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre>
<p>
The main part of our XQuery module is just a big "element constructor
expression" that generates the HTML (or rather XHTML)
of a single <code>&lt;form&gt;</code> element.
The initial values of the <code>&lt;input&gt;</code> fields are
given by embedded XQuery expressions inside <code>{curly braces}</code>.
Those use the <code>num-parameter</code> function,
which is defined in the <dfn>Query prolog</dfn>.
The <code>num-parameter</code> function uses <code>request-parameter</code>
to extract a named HTTP parameter from the URL.
(Future Qexo versions may provide alternative ways of getting request
parameters, including likely moving <code>request-parameter</code>
to a non-default name-space.)
<p>
I'll explain the control flow of our "application"
after we look at how to install and get it running.

<h2>Installing Qexo under Tomcat</h2>

<p>Installing this application is very easy, assuming you have
a web server that can run servlets.
I tested this application using version 4.1.24 of
<a href="http://jakarta.apache.org/tomcat/">Tomcat</a>,
which is a Free web server
written in Java and released by the Apache Foundation's Jakarta project.
I assume you or someone else has already installed Tomcat,
and that the environment variable <code>$CATALINA_HOME</code> is
where Tomcat is installed.</p>
<p>
Qexo is part of the
<a href="http://www.gnu.org/software/kawa/">Kawa framework</a>.
You will need to install a <code>jar</code> file of Kawa
(version 1.7 beta2 or later).
You can get <code>kawa-1.7.jar</code> from
<a href="ftp://ftp.gnu.org/pub/gnu/kawa/">the Kawa ftp site</a>
or from a <a href="http://www.gnu.org/order/ftp.html">mirror site</a>.
Install this as <code>$CATALINA_HOME/shared/lib/kawa-1.7.jar</code>.
(If you're using Tomcat 4.0.x, <code>shared/lib</code> doesn't
exist.  Install as <code>$CATALINA_HOME/lib/kawa-1.7.jar</code> instead.)</p>
<p>
If Tomcat isn't already running, start it.
For example, under Unix-like systems you can
run the script <code>$CATALINA_HOME/bin/bin/startup.sh</code>.
You may need to set the environment variable <code>JAVA_HOME</code>
to point to where Java is installed on your machine.
(On Mac OS X 10.2 this
is <code>/System/Library/Frameworks/JavaVM.framework/Home</code>.)
If you haven't changed any of the defaults,
you should now be able to point your browser at
<a href="http://localhost:8080/"><code>http://localhost:8080/</code></a>,
and get the default Tomcat home page.

<h2>Installing our web application</h2>
<p>A <dfn>web application</dfn> is a group of data,
servlets, and configuration files to handle a related set of URLs.
The servlet specification specifies the directory structure of a
web application.
Let us install our <code>adder</code> in a new web application
called <code>utils</code>.  This means that we need to create two directories:
<pre>
mkdir $CATALINA_HOME/webapps/utils
mkdir $CATALINA_HOME/webapps/utils/WEB-INF
</pre>
<p>
Each web application has a <code>web.xml</code> configuration file.
Copy the following <a href="web.xml"><code>web.xml</code></a> into
<code>$CATALINA_HOME/webapps/utils/WEB-INF/web.xml</code>:</p>
<pre>
&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;web-app&gt;
  &lt;display-name&gt;XQuery Utils&lt;/display-name&gt;

  &lt;servlet&gt;
    &lt;servlet-name&gt;KawaPageServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;gnu.kawa.servlet.KawaPageServlet&lt;/servlet-class&gt;
  &lt;/servlet&gt;

  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;KawaPageServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;*.xql&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
&lt;/web-app&gt;
</pre>
<p>
The <code>&lt;servlet-mapping&gt;</code> clause tells Tomcat (or any
other compatible web server) that if it sees a URL that matches
the pattern <code>*.xql</code> within the current
web application <code>utils</code>, then it should use the servlet named
<code>KawaPageServlet</code> to handle it.
The <code>&lt;servlet&gt;</code> clause tells Tomcat that
the servlet named <code>KawaPageServlet</code> is implemented
by the Java class <code>gnu.kawa.servlet.KawaPageServlet</code>.
(This class is included in the <code>kawa-1.7.jar</code> that
we installed earlier.)
In other words, any URL of the
form <code>http://localhost:8080/utils/*.xql</code>
or <code>http://localhost:8080/utils/*/*.xql</code> and so on
will be handled by the class <code>gnu.kawa.servlet.KawaPageServlet</code>.
<p>
So far this has all been boiler-plate.  Now finally we just need
to install our XQuery program <code>adder.xql</code> into
the <code>utils</code> web application, by copying to the file
<code>$CATALINA_HOME/webapps/utils/adder.xql</code>.

<h2>Accessing our web application</h2>
<p>
To access the web application, point you favorite browser at
<a href="http://localhost:8080/utils/adder.xql"><code>http://localhost:8080/utils/adder.xql</code></a>.
Tomcat will receive this request, use the <code>utils</code> part
to determine that it is for the <code>utils</code> web application,
and use the <code>utils/WEB-INF/web.xml</code> configuration file.
That tells Tomcat to forward the request to the <code>KawaPageServlet</code>.
<p>
The first time the <code>KawaPageServlet</code> sees a request
for <code>adder.xql</code> it will compile <code>adder.xql</code>
to a Java class named <code>adder</code>.  This class will get added
to the Java Virtual machine that is running Tomcat, but by
default the class is not written to a file.
This means that <code>adder.xql</code> will have to be re-compiled
the first time you request it each time you re-start Tomcat,
but the Kawa compiler is fast enough that there is no real gain in
keeping the compiled class around.  (Kawa also gives you the
option of <a href="http://www.gnu.org/software/qexo/servlet.html">manually compiling to a servlet</a>).
(If you're curious about the class that <code>KawaPageServlet</code> creates,
add a <code>qexo-save-class</code> parameter to the <em>initial</em> request,
as in <a href="http://localhost:8080/utils/adder.xql?qexo-save-class"><code>http://localhost:8080/utils/adder.xql?qexo-save-class</code></a>.
This will write out the compiled class to
<code>$CATALINA_HOME/webapps/utils/WEB-INF/classes/adder.class.)
<p>
After <code>KawaPageServlet</code> has compiled <code>adder.xql</code>,
it will execute the compiled body of <code>adder.xql</code>.
This first time, there won't be any parameters in the request,
so calls to the <code>request-parameter</code> function return the
specified default values: respectively 0, 0, and 1.  So the
initial values in the <code>&lt;input&gt;</code> fields
will be 0 and 1 respectively.
The result of evaluating <code>adder.xql</code> will be some XHTML,
which will be sent as the HTTP response back to your browser,
which will display as in the first image above.
<p>
Use your browser to edit the input fields,
changing them to (say) 10 and 3.
When you click <code>Submit</code> those values are used
to set the HTTP request parameters <code>sum1</code> and <code>sum2</code>,
with the browser sending the URL
<a href="http://localhost:8080/utils/adder.xql?sum1=10&sum2=2"></code>http://localhost:8080/utils/adder.xql?sum1=10&sum2=3</code></a>.
The Tomcat browser receives the request, passes it
to <code>KawaPageServlet</code>, which forwards the request to the
previously-compiled <code>adder</code> class.
This time the <code>adder</code> gets the values 10 and 3, respectively,
for the parameters <code>sum1</code> and <code>sum2</code>,
so when the new form is returned to the browser the initial
values of the two fields are 13 and 3,
which will display the second image above.
If you leave the fields as-is and again click <code>Submit</code>,
the updated forms will show 16 and 3.  And so on.

<h2>Development and Debugging</h2>

Qexo provides help for developing and debugging your applications.

<h3>XQuery syntax errors</h3/
<p>
If you request <code>adder.xql</code> after editing it,
<code>KawaPageServlet</code> will automatically re-compile it.
This makes it easy to test out changes.
If you make a syntax error, the result sent to the browser
will include error messages from the compiler.
For example, supposed you have the file <code>min-cats.xql</code>
with the following semi-nonsense:</p>
<pre>
define function min-cats($x, $y) {
let $z in " cats" return
  if (x < $y)
    $x else $y
  " cats"
(: returns number of cats
}
min-cats(3, 4)
</pre>
If you request this file, you'll see in your browser
the following error log instead:
<pre>
min-cats.xql:2:17: missing ':=' in 'let' clause
min-cats.xql:3:9: node test when focus is undefined
min-cats.xql:4:5: missing 'then'
min-cats.xql:5:9: missing '}' or ','
min-cats.xql:9:1: non-terminated comment starting at line 6
</pre>
<p>
This gives you the filename, line number, and column number
each place Qexo found a syntax error.  Sometimes an earlier error
will cause multiple error, but in this case each message
results from a separate error.  (They should all be easy to figure out,
except perhaps the second one, where the <code>$x</code> mistyped
as <code>x</code> is interpreted as a node-test in a path expression,
but Qexo can catch this as its is an undefined context for such a node-test.)

<h3>Run-time exceptions</h3>
<p>
If you cause a run-time error, you will get a stack trace
that will hopefully help you track down the error.
Here is an application <a href="list-data.xql"><code>list-data.xql</code></a>
that looks for a non-existant <code>"data.txt"</code>:
<pre>
define function listing($url) {
  (: doc($url) replaced document($url) in the May'03 spec. :)
  &lt;pre&gt;{ doc($url) }&lt;/pre&gt;
}
listing("data.txt"), ""
</pre>
<p>
If you try to run this file, Tomcat will return a Java execution
stack trace.  Look for the <code>root cause</code>,
which looks like:
<pre>
java.io.FileNotFoundException: http://localhost:8080/data.txt
    at sun.net.www.protocol.http.HttpURLConnection
       .getInputStream(HttpURLConnection.java:707)
    at gnu.kawa.xml.XMLParser.(XMLParser.java:57)
    at gnu.kawa.xml.XMLParser.(XMLParser.java:49)
    at gnu.kawa.xml.XMLParser.(XMLParser.java:42)
    at gnu.kawa.xml.Document.parse(Document.java:52)
    at gnu.kawa.xml.Document.apply(Document.java:94)
    at gnu.mapping.CallContext.runUntilDone(CallContext.java:258)
    at gnu.mapping.CallContext.runUntilValue(CallContext.java:290)
    at listData.listing$T(list-data.xql:3)
    at listData.apply(list-data.xql)
    at gnu.mapping.CpsMethodProc.apply(CpsMethodProc.java:49)
    at gnu.mapping.CallContext.runUntilDone(CallContext.java:258)
    at gnu.mapping.CallContext.runUntilValue(CallContext.java:290)
    at listData.apply(list-data.xql:5)
    at gnu.kawa.servlet.KawaPageServlet.apply(KawaPageServlet.java:51)
    at gnu.kawa.servlet.KawaServlet.doGet(KawaServlet.java:57)
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:740)
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:853)
    at org.apache.catalina.core.ApplicationFilterChain
       .internalDoFilter(ApplicationFilterChain.java:247)
    ... <i>lots of Tomcat internals</i> ...
    at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable
       .run(ThreadPool.java:619)
    at java.lang.Thread.run(Thread.java:554)
</pre>
<p>
The cause is a <code>FileNotFoundException</code>, and the
exception message names the URL it was looking for.  (The <code>data.txt</code>
is a relative URL that gets resolved to that of the web application.)
The first few lines are within Kawa run-time routines, but then we get
to two lines in the <code>listData</code> class, which is the Java
"mangling" of the <code>list-data.xql</code> file.
The first one specifies that we're at line 3, in method <code>listing$T</code>,
which is the Java "mangling" of the <code>listing</code> function.
And that is indeed where the bad call to <code>doc</code> is.
A little further down you will see a
call at <code>list-data.xql</code> line 5, which is where
<code>listing</code> gets called.  (There are some calls in
between for technical reasons.)
<p>
Note how we append an empty (<code>, ""</code>) after the call to
<code>listing</code>.  This is to suppress tail-call-optimization,
which is an optimization done when the last thing in a function is
a call to another function.  The optimization allows some kinds of
recursion to execute without a stack overflow, but the disadvantage is
that stack traces can be confusing.  So when debugging, if may sometimes
be helpful to append some empty value so <em>that</em> becomes
the last expression in the function.

<h3>Adding trace output</h3>
<p>
Sometimes it is difficult to understand what an application is
doing, in which case it is useful to add print statements for debugging
purposes.  XQuery is a side-effect-free language, so it doesn't
really have print statements.
However, the May 2003 draft specification added a <code>trace</code>
which takes two parameters.  The first parameter
can be an arbitary value that is returned
as the result of the <code>trace</code> call.  The other parameter
is descriptive string.  Both values are written to a "trace data set"
in an implementation-defined manner.  For example you could
replace the <code>num-parameter</code> implementation
of <code>adder.xql</code> by the following:
<pre>
define function num-parameter($name, $default) {
  trace (
  number(request-parameter($name, $default))
  , concat("num-parameter of '", $name, "' is:"))
}
</pre>
<p>
That writes the following output to Qexo's standard error output
(<code>System.err</code>).  Tomcat re-directs the error output
to the file <code>$CATALINA_HOME/logs/catalina.out</code>,
where you can read it.
<pre>
XQuery-trace: num-parameter of 'sum1' is: 0
XQuery-trace: num-parameter of 'sum2' is: 0
XQuery-trace: num-parameter of 'sum2' is: 1
</pre>

    <hr>
    <address><a href="mailto:per@bothner.com">Per Bothner</a></address>
<!-- Created: Mon May  5 20:28:35 PDT 2003 -->
<!-- hhmts start -->
Last modified: Wed May 21 13:57:22 PDT 2003
<!-- hhmts end -->
  </body>
</html>
